# AI Editor 2.0 - Full Stack Deployment
# Next.js Frontend + Python Workers + Redis + PostgreSQL

services:
  # =============================================================================
  # NEXT.JS FRONTEND WEB SERVICE
  # Dashboard UI at app.pivotmedia.ai
  # =============================================================================
  - type: web
    name: ai-editor-dashboard
    runtime: node
    region: oregon
    plan: starter
    rootDir: ai-editor-2.0-full-stack-application/app
    buildCommand: npm install && npm run build
    startCommand: npm start
    envVars:
      # Database
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      # Redis (for job status)
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      # Airtable - Pivot Media Master Base
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_BASE_ID
        value: appwSozYTkrsQWUXB
      - key: AIRTABLE_ARTICLES_TABLE
        value: tblGumae8KDpsrWvh
      - key: AIRTABLE_NEWSLETTER_STORIES_TABLE
        value: tblY78ziWp5yhiGXp
      - key: AIRTABLE_NEWSLETTER_ISSUES_TABLE
        value: tbl7mcCCGbjEfli25
      # Airtable - AI Editor 2.0 Base
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl
      - key: AI_EDITOR_PREFILTER_LOG_TABLE
        value: tbl72YMsm9iRHj3sp
      - key: AI_EDITOR_SELECTED_SLOTS_TABLE
        value: tblzt2z7r512Kto3O
      - key: AI_EDITOR_DECORATION_TABLE
        value: tbla16LJCf5Z6cRn3
      # AI_EDITOR_SOURCE_SCORES_TABLE removed 1/1/26 - credibility now in system prompts
      # Mautic (for analytics)
      - key: MAUTIC_BASE_URL
        value: https://app.pivotnews.com
      - key: MAUTIC_USERNAME
        sync: false
      - key: MAUTIC_PASSWORD
        sync: false
      # Auth (magic link)
      - key: RESEND_API_KEY
        sync: false
      - key: NEXTAUTH_SECRET
        generateValue: true
      - key: NEXTAUTH_URL
        sync: false
      # Node environment
      - key: NODE_ENV
        value: production
      # Trigger service for job execution
      - key: TRIGGER_SERVICE_URL
        sync: false  # Set to https://ai-editor-trigger.onrender.com
      - key: TRIGGER_SECRET
        sync: false  # Must match ai-editor-trigger service
    autoDeploy: true
    healthCheckPath: /api/health

  # =============================================================================
  # PYTHON WORKER SERVICE
  # Processes background jobs from Redis queue
  # =============================================================================
  - type: worker
    name: ai-editor-worker
    runtime: python
    region: oregon
    plan: starter
    buildCommand: pip install -r requirements.txt
    startCommand: python worker.py
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      # Database - CRITICAL: Required for loading prompts from Postgres
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      # Airtable - Pivot Media Master Base
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_BASE_ID
        value: appwSozYTkrsQWUXB
      - key: AIRTABLE_ARTICLES_TABLE
        value: tblGumae8KDpsrWvh
      - key: AIRTABLE_NEWSLETTER_STORIES_TABLE
        value: tblY78ziWp5yhiGXp
      - key: AIRTABLE_NEWSLETTER_ISSUES_TABLE
        value: tbl7mcCCGbjEfli25
      - key: AIRTABLE_NEWSLETTER_ISSUES_ARCHIVE_TABLE
        value: tblHo0xNj8nbzMHNI
      # Airtable - AI Editor 2.0 Base
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl
      - key: AI_EDITOR_PREFILTER_LOG_TABLE
        value: tbl72YMsm9iRHj3sp
      - key: AI_EDITOR_SELECTED_SLOTS_TABLE
        value: tblzt2z7r512Kto3O
      - key: AI_EDITOR_DECORATION_TABLE
        value: tbla16LJCf5Z6cRn3
      # AI_EDITOR_SOURCE_SCORES_TABLE removed 1/1/26 - credibility now in system prompts
      # Airtable - P5 Social Posts Base
      - key: P5_SOCIAL_BASE_ID
        sync: false
      - key: P5_SOCIAL_POSTS_TABLE_ID
        sync: false
      # AI APIs
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      # Image Storage
      - key: CLOUDINARY_URL
        sync: false
      - key: CLOUDFLARE_ACCOUNT_ID
        sync: false
      - key: CLOUDFLARE_API_KEY
        sync: false
      # Mautic
      - key: MAUTIC_BASE_URL
        value: https://app.pivotnews.com
      - key: MAUTIC_USERNAME
        sync: false
      - key: MAUTIC_PASSWORD
        sync: false
      - key: MAUTIC_SEGMENT_ID
        value: "1"
    autoDeploy: true

  # =============================================================================
  # PYTHON SCHEDULER SERVICE
  # Runs RQ scheduler for cron jobs (Steps 1-5)
  # =============================================================================
  - type: worker
    name: ai-editor-scheduler
    runtime: python
    region: oregon
    plan: starter
    buildCommand: pip install -r requirements.txt
    startCommand: python worker.py --with-scheduler
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      # Minimal env vars - scheduler just enqueues jobs
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_BASE_ID
        value: appwSozYTkrsQWUXB
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl
    autoDeploy: true

  # =============================================================================
  # PYTHON HTTP TRIGGER SERVICE
  # Exposes HTTP endpoints to trigger jobs from Next.js dashboard
  # =============================================================================
  - type: web
    name: ai-editor-trigger
    runtime: python
    region: oregon
    plan: starter
    rootDir: ai-editor-2.0-full-stack-application/app/workers
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn --bind 0.0.0.0:$PORT trigger:app
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      - key: TRIGGER_SECRET
        generateValue: true
      # Airtable - Pivot Media Master Base
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_BASE_ID
        value: appwSozYTkrsQWUXB
      - key: AIRTABLE_ARTICLES_TABLE
        value: tblGumae8KDpsrWvh
      - key: AIRTABLE_NEWSLETTER_STORIES_TABLE
        value: tblY78ziWp5yhiGXp
      - key: AIRTABLE_NEWSLETTER_ISSUES_TABLE
        value: tbl7mcCCGbjEfli25
      - key: AIRTABLE_NEWSLETTER_ISSUES_ARCHIVE_TABLE
        value: tblHo0xNj8nbzMHNI
      # Airtable - AI Editor 2.0 Base
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl
      - key: AI_EDITOR_PREFILTER_LOG_TABLE
        value: tbl72YMsm9iRHj3sp
      - key: AI_EDITOR_SELECTED_SLOTS_TABLE
        value: tblzt2z7r512Kto3O
      - key: AI_EDITOR_DECORATION_TABLE
        value: tbla16LJCf5Z6cRn3
      # AI_EDITOR_SOURCE_SCORES_TABLE removed 1/1/26 - credibility now in system prompts
      # Database for prompts
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      # AI APIs (needed for job imports)
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      # Image Storage
      - key: CLOUDINARY_URL
        sync: false
      - key: CLOUDFLARE_ACCOUNT_ID
        sync: false
      - key: CLOUDFLARE_API_KEY
        sync: false
      # Mautic
      - key: MAUTIC_BASE_URL
        value: https://app.pivotnews.com
      - key: MAUTIC_USERNAME
        sync: false
      - key: MAUTIC_PASSWORD
        sync: false
      - key: MAUTIC_SEGMENT_ID
        value: "1"
    autoDeploy: true
    healthCheckPath: /health

  # =============================================================================
  # CHAINED PIPELINE CRONS - 3 Daily Cycles
  # Each cycle runs: Ingest → AI Scoring → Pre-Filter (all 5 slots sequential)
  # Manual slot buttons (1-5) on dashboard remain separate and functional.
  #
  # Schedule (all times ET):
  #   Cycle 1 (Night):   2:00 AM  → Complete ~5:30 AM
  #   Cycle 2 (Morning): 9:30 AM  → Complete ~1:00 PM
  #   Cycle 3 (EOD):     5:00 PM  → Complete ~8:30 PM (before 8 PM deadline)
  # =============================================================================

  # Cycle 1: Night - Process overnight/international articles
  - type: cron
    name: ai-editor-pipeline-night
    runtime: python
    region: oregon
    plan: starter
    schedule: "0 7 * * *"  # 2:00 AM ET = 7:00 UTC
    rootDir: workers  # CRITICAL: Just "workers", NOT full nested path!
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from jobs.pipeline import run_full_pipeline; run_full_pipeline()"
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_BASE_ID
        value: appwSozYTkrsQWUXB
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl
      - key: AI_EDITOR_PREFILTER_LOG_TABLE
        value: tbl72YMsm9iRHj3sp
      - key: AI_EDITOR_SELECTED_SLOTS_TABLE
        value: tblzt2z7r512Kto3O
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false

  # Cycle 2: Morning - Process morning publications (WSJ, NYT, etc.)
  - type: cron
    name: ai-editor-pipeline-morning
    runtime: python
    region: oregon
    plan: starter
    schedule: "30 14 * * *"  # 9:30 AM ET = 14:30 UTC
    rootDir: workers  # CRITICAL: Just "workers", NOT full nested path!
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from jobs.pipeline import run_full_pipeline; run_full_pipeline()"
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_BASE_ID
        value: appwSozYTkrsQWUXB
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl
      - key: AI_EDITOR_PREFILTER_LOG_TABLE
        value: tbl72YMsm9iRHj3sp
      - key: AI_EDITOR_SELECTED_SLOTS_TABLE
        value: tblzt2z7r512Kto3O
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false

  # Cycle 3: EOD - Process end-of-day stories (must complete by ~8:30 PM)
  - type: cron
    name: ai-editor-pipeline-eod
    runtime: python
    region: oregon
    plan: starter
    schedule: "0 22 * * *"  # 5:00 PM ET = 22:00 UTC
    rootDir: workers  # CRITICAL: Just "workers", NOT full nested path!
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from jobs.pipeline import run_full_pipeline; run_full_pipeline()"
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AIRTABLE_BASE_ID
        value: appwSozYTkrsQWUXB
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl
      - key: AI_EDITOR_PREFILTER_LOG_TABLE
        value: tbl72YMsm9iRHj3sp
      - key: AI_EDITOR_SELECTED_SLOTS_TABLE
        value: tblzt2z7r512Kto3O
      - key: ANTHROPIC_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false

  # =============================================================================
  # DIRECT FEED EXTRACTION CRONS - 3 Daily Cycles
  # Runs 1:45 after each pipeline cycle to ingest non-Google News RSS feeds
  # These run SEPARATELY from Google News decoding (which is slow)
  #
  # Schedule (all times ET):
  #   Cycle 1 (Night):   3:45 AM  (1:45 after 2:00 AM pipeline)
  #   Cycle 2 (Morning): 11:15 AM (1:45 after 9:30 AM pipeline)
  #   Cycle 3 (EOD):     6:45 PM  (1:45 after 5:00 PM pipeline)
  # =============================================================================

  # Direct Feed Cycle 1: Night
  - type: cron
    name: ai-editor-direct-feeds-night
    runtime: python
    region: oregon
    plan: starter
    schedule: "45 8 * * *"  # 3:45 AM ET = 8:45 UTC
    rootDir: workers
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from jobs.ingest_direct_feeds import ingest_direct_feeds; ingest_direct_feeds()"
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl

  # Direct Feed Cycle 2: Morning
  - type: cron
    name: ai-editor-direct-feeds-morning
    runtime: python
    region: oregon
    plan: starter
    schedule: "15 16 * * *"  # 11:15 AM ET = 16:15 UTC
    rootDir: workers
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from jobs.ingest_direct_feeds import ingest_direct_feeds; ingest_direct_feeds()"
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl

  # Direct Feed Cycle 3: EOD
  - type: cron
    name: ai-editor-direct-feeds-eod
    runtime: python
    region: oregon
    plan: starter
    schedule: "45 23 * * *"  # 6:45 PM ET = 23:45 UTC
    rootDir: workers
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from jobs.ingest_direct_feeds import ingest_direct_feeds; ingest_direct_feeds()"
    envVars:
      - key: REDIS_URL
        fromService:
          name: ai-editor-redis
          type: redis
          property: connectionString
      - key: DATABASE_URL
        fromDatabase:
          name: ai-editor-db
          property: connectionString
      - key: AIRTABLE_API_KEY
        sync: false
      - key: AI_EDITOR_BASE_ID
        value: appglKSJZxmA9iHpl

# =============================================================================
# DATABASES
# =============================================================================
databases:
  # PostgreSQL - Job tracking, audit logs, users, system prompts
  - name: ai-editor-db
    databaseName: ai_editor
    plan: starter
    region: oregon
    ipAllowList: []

  # Redis - Job queue for RQ workers
  - name: ai-editor-redis
    type: redis
    plan: starter
    region: oregon
    ipAllowList: []
    maxmemoryPolicy: allkeys-lru
